# -------- Pre-Initialization --------

# Powerlevel10k instant prompt (must be at the top)
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# -------- XDG Variables --------

export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
export XDG_STATE_HOME="${XDG_STATE_HOME:-$HOME/.local/state}"

mkdir -p "$XDG_STATE_HOME/zsh" "$XDG_CACHE_HOME/zsh"

# -------- Custom Variables --------

export DEV="$HOME/dev"

export PROJECTS="$DEV/projects"
export TOOLS="$DEV/tools"
export SCRIPTS="$DEV/scripts"
export TEMP="$DEV/temp"

export WORK="$PROJECTS/work"
export PERSONAL="$PROJECTS/personal"
export SANDBOX="$PROJECTS/sandbox"

export DOTFILES="$(chezmoi source-path 2>/dev/null || echo "$HOME/.local/share/chezmoi")"
export BREW_PREFIX="${BREW_PREFIX:-$(brew --prefix 2>/dev/null)}"

# -------- Shell configuration (Zsh) --------

# Powerlevel10k Theme
[[ -f "$BREW_PREFIX/share/powerlevel10k/powerlevel10k.zsh-theme" ]] && source "$BREW_PREFIX/share/powerlevel10k/powerlevel10k.zsh-theme"
[[ -f "$HOME/.p10k.zsh" ]] && source "$HOME/.p10k.zsh"

# History
HISTFILE="$XDG_STATE_HOME/zsh/history"
HISTSIZE=50000
SAVEHIST=10000
HISTDUP=erase
setopt appendhistory
setopt incappendhistory
setopt share_history
setopt hist_expire_dups_first
setopt hist_ignore_all_dups
setopt hist_ignore_space
setopt hist_save_no_dups
setopt hist_verify

# Completion
autoload -Uz compinit
compinit -u -d "$XDG_CACHE_HOME/zsh/zcompdump-$ZSH_VERSION"
zstyle ":completion:*" cache-path "$XDG_CACHE_HOME/zsh/zcompcache"
zstyle ":completion:*" menu select
zstyle ":completion:*" list-rows-first false
zstyle ":completion:*" list-packed false
zstyle ":completion:*" list-colors "${(s.:.)LS_COLORS:-}"
zstyle ":completion:*" matcher-list "m:{a-zA-Z}={A-Za-z}"
setopt auto_menu
setopt complete_in_word
setopt always_to_end
unsetopt menu_complete
unsetopt flowcontrol
bindkey "^I" expand-or-complete

# History Substring Search
HSS="$BREW_PREFIX/share/zsh-history-substring-search/zsh-history-substring-search.zsh"
[[ -f "$HSS" ]] && source "$HSS"
HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_FOUND=false
HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_NOT_FOUND=false
bindkey "^[[A" history-substring-search-up
bindkey "^[[B" history-substring-search-down

# Fuzzy Finder (fzf)
if command -v fzf >/dev/null; then
  source "$BREW_PREFIX/opt/fzf/shell/completion.zsh"
  source "$BREW_PREFIX/opt/fzf/shell/key-bindings.zsh"
fi

# Syntax Highlighting
SYNTAX="$BREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
[[ -f "$SYNTAX" ]] && source "$SYNTAX"

# -------- Tool Paths & Env Vars --------

# Android SDK
export ANDROID_HOME="$HOME/Library/Android/sdk"
export PATH="$ANDROID_HOME/platform-tools:$PATH"
export PATH="$ANDROID_HOME/emulator:$PATH"

# Custom scripts
export PATH="$SCRIPTS:$PATH"

# Homebrew
export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_INSTALL_BADGE="âœ“"
export PATH="$BREW_PREFIX/sbin:$PATH"

# SQLite
export SQLITE_HISTORY="$XDG_STATE_HOME/sqlite_history"

# -------- Global Configuration --------

export LANG="en_US.UTF-8"

# Editor
if [[ -n "$SSH_CONNECTION" ]]; then
  export EDITOR="nano"
else
  export EDITOR="cursor"
fi

# -------- Aliases --------

# Navigation aliases
alias ...='../..'
alias ....='../../..'
alias .....='../../../..'
alias ......='../../../../..'

# Git cleanup aliases
alias cleanupbranches="delete-local-only-git-branches.sh"
alias cleanupbranch="cleanupbranches"
alias cleanupgitbranches="cleanupbranches"
alias cleanupgitbranch="cleanupbranches"

# PHP services aliases
alias startphp="start-php-services.sh"
alias stopphp="stop-php-services.sh"

# Common aliases
alias ip="ipconfig getifaddr en0 || ipconfig getifaddr en1"
alias gitconfig="code ~/.gitconfig"
alias zshconfig="code ~/.zshrc"
alias zshsource="source ~/.zshrc"
alias sshconfig="code ~/.ssh/config"
alias sshfolder="cd ~/.ssh"
alias hostsconfig="code /etc/hosts"
alias hostconfig="hostsconfig"
alias vhostsconfig="code /usr/local/etc/httpd/extra/httpd-vhosts.conf"
alias vhostconfig="vhostsconfig"
alias httpdhostsconfig="vhostsconfig"
alias httpdhostconfig="vhostsconfig"
alias httpdconfig="code /usr/local/etc/httpd/httpd.conf"
alias dnsmasqconfig="code /usr/local/etc/dnsmasq.conf"

# Sublime Text alias
alias sublime="/Applications/Sublime\ Text.app/Contents/SharedSupport/bin/subl --new-window $@"

# Better SQLite shell alias
alias sqlite3="rlwrap sqlite3"

# -------- Post-Initialization --------

# Mise - Tools version manager (must be at the bottom)
eval "$(mise activate zsh)"
